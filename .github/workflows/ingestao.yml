name: Ingest√£o de Dados

on:
  schedule:
    - cron: "0 12 * * *"  # Diariamente √†s 9h Bras√≠lia (12h UTC)
  workflow_dispatch:  # Permite executar manualmente

env:
  PYTHON_VERSION: '3.11'

jobs:
  ingestao:
    name: Ingest√£o API Queimados
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Autenticar no Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_KEYFILE_JSON }}

      - name: Executar ingest√£o de dados
        env:
          GCP_KEYFILE_JSON: ${{ secrets.GCP_KEYFILE_JSON }}
        run: |
          echo "üöÄ Iniciando ingest√£o de dados..."
          python scripts/ingest_queimados_despesas.py

  notificar-falha:
    name: Notificar Falha
    runs-on: ubuntu-latest
    needs: ingestao
    if: failure()

    steps:
      - name: Enviar email de falha
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Ingest√£o de Dados Falhou"
          to: christianbasilio97@gmail.com
          from: Monitor P√∫blico <${{ secrets.EMAIL_USERNAME }}>
          body: |
            üö® A ingest√£o de dados falhou!

            üìã Detalhes:
            - Reposit√≥rio: ${{ github.repository }}
            - Workflow: Ingest√£o de Dados
            - Run ID: ${{ github.run_id }}

            üîó Ver logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notificar-sucesso:
    name: Notificar Sucesso
    runs-on: ubuntu-latest
    needs: ingestao
    if: success()

    steps:
      - name: Enviar email de sucesso
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Ingest√£o de Dados - Sucesso"
          to: christianbasilio97@gmail.com
          from: Monitor P√∫blico <${{ secrets.EMAIL_USERNAME }}>
          body: |
            ‚úÖ Ingest√£o de dados conclu√≠da com sucesso!

            üìã Detalhes:
            - Reposit√≥rio: ${{ github.repository }}
            - Workflow: Ingest√£o de Dados

            üîó Ver logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

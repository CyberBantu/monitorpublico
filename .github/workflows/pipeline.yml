name: Ingestao Despesas Queimados

on:
  schedule:
    - cron: "0 17 * * *"
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create dbt profile
        run: |
          mkdir -p profiles
          cat > profiles/profiles.yml <<'EOF'
          monitorpublico:
            target: dev
            outputs:
              dev:
                type: bigquery
                method: service-account
                project: "monitorpublico"
                dataset: "despesas_queimados"
                location: "US"
                threads: 4
          EOF

      - name: Authenticate service account (no file)
        run: |
          python - <<'PY'
          import json
          from google.oauth2 import service_account

          CREDS = json.loads('${{ secrets.GCP_KEYFILE_JSON }}')

          creds = service_account.Credentials.from_service_account_info(CREDS)

          print("Autenticação OK")
          PY

      - name: Run ingestion script
        env:
          GCP_KEYFILE_JSON: ${{ secrets.GCP_KEYFILE_JSON }}
        run: |
          python scripts/ingest_queimados_despesas.py

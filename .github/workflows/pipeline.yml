name: Pipeline de Dados - Monitor P√∫blico

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 17 * * *"  # Executa diariamente √†s 17h UTC (14h Bras√≠lia)
  workflow_dispatch:  # Permite executar manualmente

env:
  PYTHON_VERSION: '3.11'

jobs:
  ingestao-e-transformacao:
    name: Ingest√£o e Transforma√ß√£o dbt
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do c√≥digo
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      # 2. Configurar Python
      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. Instalar depend√™ncias
      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Autenticar no Google Cloud
      - name: Autenticar no Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_KEYFILE_JSON }}

      # 5. Criar profiles.yml para dbt
      - name: Configurar profiles.yml do dbt
        run: |
          mkdir -p ~/.dbt
          echo '${{ secrets.GCP_KEYFILE_JSON }}' > /tmp/gcp_keyfile.json
          cat <<EOF > ~/.dbt/profiles.yml
          monitorpublico:
            target: prod
            outputs:
              prod:
                type: bigquery
                method: service-account
                project: monitorpublico
                dataset: staging
                threads: 4
                keyfile: /tmp/gcp_keyfile.json
                location: US
          EOF

      # 6. Executar script de ingest√£o
      - name: Executar ingest√£o de dados (API Queimados)
        env:
          GCP_KEYFILE_JSON: ${{ secrets.GCP_KEYFILE_JSON }}
        run: |
          echo "üöÄ Iniciando ingest√£o de dados..."
          python scripts/ingest_queimados_despesas.py

      # 7. Verificar conex√£o dbt
      - name: Verificar conex√£o dbt
        run: |
          echo "üîç Verificando conex√£o com BigQuery..."
          dbt debug

      # 8. Executar dbt run
      - name: Executar dbt run
        run: |
          echo "üîÑ Executando transforma√ß√µes dbt..."
          dbt run

      # 9. Executar testes dbt (opcional)
      - name: Executar testes dbt
        run: |
          echo "üß™ Executando testes dbt..."
          dbt test || echo "‚ö†Ô∏è Alguns testes falharam, mas continuando..."
        continue-on-error: true

  # Job para notifica√ß√£o de falha
  notificar-falha:
    name: Notificar Falha por Email
    runs-on: ubuntu-latest
    needs: ingestao-e-transformacao
    if: failure()

    steps:
      - name: Enviar email de falha
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Pipeline Monitor P√∫blico Falhou"
          to: christianbasilio97@gmail.com
          from: Monitor P√∫blico Pipeline <${{ secrets.EMAIL_USERNAME }}>
          body: |
            üö® A pipeline de dados falhou!

            üìã Detalhes:
            - Reposit√≥rio: ${{ github.repository }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Autor: ${{ github.actor }}

            üîó Ver logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # Job para notifica√ß√£o de sucesso
  notificar-sucesso:
    name: Notificar Sucesso por Email
    runs-on: ubuntu-latest
    needs: ingestao-e-transformacao
    if: success()

    steps:
      - name: Enviar email de sucesso
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Pipeline Monitor P√∫blico - Sucesso"
          to: christianbasilio97@gmail.com
          from: Monitor P√∫blico Pipeline <${{ secrets.EMAIL_USERNAME }}>
          body: |
            ‚úÖ A pipeline de dados foi executada com sucesso!

            üìã Detalhes:
            - Reposit√≥rio: ${{ github.repository }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Autor: ${{ github.actor }}

            üîó Ver logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

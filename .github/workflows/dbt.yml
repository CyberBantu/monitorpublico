name: dbt Run

on:
  push:
    branches:
      - main
    paths:
      - 'models/**'
      - 'macros/**'
      - 'dbt_project.yml'
  schedule:
    - cron: "30 12 * * *"  # Diariamente Ã s 9:30h BrasÃ­lia (12:30h UTC) - depois da ingestÃ£o
  workflow_dispatch:  # Permite executar manualmente

env:
  PYTHON_VERSION: '3.11'

jobs:
  dbt-run:
    name: dbt Run
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Autenticar no Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_KEYFILE_JSON }}

      - name: Configurar profiles.yml do dbt
        run: |
          mkdir -p ~/.dbt
          echo '${{ secrets.GCP_KEYFILE_JSON }}' > /tmp/gcp_keyfile.json
          cat <<EOF > ~/.dbt/profiles.yml
          monitorpublico:
            target: prod
            outputs:
              prod:
                type: bigquery
                method: service-account
                project: monitorpublico
                dataset: staging
                threads: 4
                keyfile: /tmp/gcp_keyfile.json
                location: US
          EOF

      - name: Verificar conexÃ£o dbt
        run: |
          echo "ğŸ” Verificando conexÃ£o com BigQuery..."
          dbt debug

      - name: Executar dbt run
        run: |
          echo "ğŸ”„ Executando transformaÃ§Ãµes dbt..."
          dbt run

      - name: Executar testes dbt
        run: |
          echo "ğŸ§ª Executando testes dbt..."
          dbt test || echo "âš ï¸ Alguns testes falharam"
        continue-on-error: true

  notificar-falha:
    name: Notificar Falha
    runs-on: ubuntu-latest
    needs: dbt-run
    if: failure()

    steps:
      - name: Enviar email de falha
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ dbt Run Falhou"
          to: christianbasilio97@gmail.com
          from: Monitor PÃºblico <${{ secrets.EMAIL_USERNAME }}>
          body: |
            ğŸš¨ O dbt run falhou!

            ğŸ“‹ Detalhes:
            - RepositÃ³rio: ${{ github.repository }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Workflow: dbt Run

            ğŸ”— Ver logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notificar-sucesso:
    name: Notificar Sucesso
    runs-on: ubuntu-latest
    needs: dbt-run
    if: success()

    steps:
      - name: Enviar email de sucesso
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… dbt Run - Sucesso"
          to: christianbasilio97@gmail.com
          from: Monitor PÃºblico <${{ secrets.EMAIL_USERNAME }}>
          body: |
            âœ… dbt run executado com sucesso!

            ğŸ“‹ Detalhes:
            - RepositÃ³rio: ${{ github.repository }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}

            ğŸ”— Ver logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
